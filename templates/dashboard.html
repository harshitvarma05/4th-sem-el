<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />
    <title>Smart Bins Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body
    class="relative flex w-full min-h-screen flex-col bg-[#141414] overflow-x-hidden"
    style='font-family:"Plus Jakarta Sans","Noto Sans",sans-serif;'
  >
    <div class="layout-container flex h-full grow flex-col">
      <!-- Header -->
      <header class="flex justify-end border-b border-[#27313A] px-10 py-3">
        <button
          id="login-toggle-btn"
          class="rounded-full bg-[#359EFF] px-4 py-2 text-sm font-bold text-white"
        >
          Login / Sign Up
        </button>
      </header>

      <!-- Main Content -->
      <div class="flex flex-1 justify-center py-10 px-10">
        <div class="layout-content-container flex flex-col w-full max-w-[960px] gap-10">
          <!-- Auth Form -->
          <div
            id="auth-container"
            class="hidden mx-auto w-full max-w-md space-y-4 bg-[#1B2127] p-6 rounded-lg"
          >
            <h3 class="text-white text-2xl font-semibold text-center">
              Please Log In
            </h3>
            <input
              id="email"
              type="email"
              placeholder="Email"
              class="w-full rounded border border-[#27313A] bg-[#141414] px-3 py-2 text-white placeholder-[#9BACBB]"
            />
            <input
              id="password"
              type="password"
              placeholder="Password"
              class="w-full rounded border border-[#27313A] bg-[#141414] px-3 py-2 text-white placeholder-[#9BACBB]"
            />
            <div class="flex justify-between">
              <button
                id="login-btn"
                class="flex-1 rounded-full bg-[#359EFF] px-4 py-2 text-white"
              >
                Log In
              </button>
              <button
                id="signup-btn"
                class="ml-4 flex-1 rounded-full bg-[#27313A] px-4 py-2 text-white"
              >
                Sign Up
              </button>
            </div>
            <p id="auth-error" class="text-red-500 text-center"></p>
          </div>

          <!-- Dashboard -->
          <div id="dashboard" class="hidden space-y-8">
            <h1 class="text-3xl font-bold text-white text-center">
              My Smart Bins
            </h1>

            <!-- Bins List & Add -->
            <div class="space-y-4">
              <h2 class="text-xl font-semibold text-white">Bins</h2>
              <ul id="bin-list" class="space-y-2"></ul>
              <form id="add-bin-form" class="flex gap-4">
                <input
                  name="location"
                  placeholder="Location"
                  required
                  class="flex-1 rounded border border-[#27313A] bg-[#141414] px-3 py-2 text-white"
                />
                <input
                  name="weight"
                  type="number"
                  placeholder="Weight (kg)"
                  required
                  class="w-24 rounded border border-[#27313A] bg-[#141414] px-3 py-2 text-white"
                />
                <button
                  type="submit"
                  class="rounded-full bg-[#359EFF] px-4 py-2 text-white"
                >
                  Add
                </button>
              </form>
              <p id="add-bin-error" class="text-red-500"></p>
            </div>

            <!-- Prediction -->
            <div>
              <h2 class="text-xl font-semibold text-white">
                Donation Prediction
              </h2>
              <p
                id="prediction"
                class="mt-2 rounded bg-[#1B2127] p-4 text-lg text-[#9BACBB]"
              >
                — waiting for prediction —
              </p>
            </div>

            <!-- Routes -->
            <div>
              <h2 class="text-xl font-semibold text-white">
                Optimized Routes
              </h2>
              <ul id="routes-list" class="space-y-2"></ul>
            </div>

            <!-- Charts -->
            <div id="charts" class="space-y-8">
              <div>
                <h2 class="text-xl font-semibold text-white">
                  Donation History
                </h2>
                <canvas
                  id="donations-chart"
                  class="bg-white rounded-lg p-4"
                ></canvas>
              </div>
              <div>
                <h2 class="text-xl font-semibold text-white">
                  Bin Weight History
                </h2>
                <canvas id="bins-chart" class="bg-white rounded-lg p-4"></canvas>
              </div>
            </div>

            <!-- NGO Requests & Matcher -->
            <div>
              <h2 class="text-xl font-semibold text-white">
                NGO Requests
              </h2>
              <form id="add-ngo-form" class="flex gap-4 mb-4">
                <input
                  name="name"
                  placeholder="NGO Name"
                  required
                  class="flex-1 rounded border border-[#27313A] bg-[#141414] px-3 py-2 text-white"
                />
                <input
                  name="urgency"
                  type="number"
                  placeholder="Urgency"
                  required
                  class="w-24 rounded border border-[#27313A] bg-[#141414] px-3 py-2 text-white"
                />
                <button
                  type="submit"
                  class="rounded-full bg-[#359EFF] px-4 py-2 text-white"
                >
                  Add
                </button>
              </form>
              <p id="add-ngo-error" class="text-red-500"></p>
              <ul id="ngo-list" class="space-y-2 mb-4"></ul>
              <button
                id="match-btn"
                class="rounded-full bg-[#359EFF] px-4 py-2 text-white"
              >
                Match Donations
              </button>
              <ul id="matches-list" class="space-y-2 mt-4"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase & Socket.IO -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script
      src="https://cdn.socket.io/4.5.4/socket.io.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      // === Firebase Config – REPLACE with your real values ===
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDg1O392tHfv7PhjYeZmQTK5TesT8CNC0Q",
  authDomain: "el4thsem-59649.firebaseapp.com",
  projectId: "el4thsem-59649",
  storageBucket: "el4thsem-59649.firebasestorage.app",
  messagingSenderId: "378011185180",
  appId: "1:378011185180:web:ed447ce072c17c7956efd9",
  measurementId: "G-6LQQTRH2NS"
};
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      // UI references
      const toggleBtn     = document.getElementById("login-toggle-btn");
      const authContainer = document.getElementById("auth-container");
      const dashboard     = document.getElementById("dashboard");
      const emailInput    = document.getElementById("email");
      const passInput     = document.getElementById("password");
      const loginBtn      = document.getElementById("login-btn");
      const signupBtn     = document.getElementById("signup-btn");
      const authError     = document.getElementById("auth-error");
      const binList       = document.getElementById("bin-list");
      const addBinForm    = document.getElementById("add-bin-form");
      const addBinError   = document.getElementById("add-bin-error");
      const predictionEl  = document.getElementById("prediction");
      const routesList    = document.getElementById("routes-list");
      const donationsCtx  = document.getElementById("donations-chart");
      const binsCtx       = document.getElementById("bins-chart");
      const addNgoForm    = document.getElementById("add-ngo-form");
      const addNgoError   = document.getElementById("add-ngo-error");
      const ngoList       = document.getElementById("ngo-list");
      const matchBtn      = document.getElementById("match-btn");
      const matchesList   = document.getElementById("matches-list");

      // Toggle auth form
      authContainer.classList.add("hidden");
      toggleBtn.onclick = () => authContainer.classList.toggle("hidden");

      // Auth handlers
      loginBtn.onclick = () => {
        authError.textContent = "";
        auth.signInWithEmailAndPassword(emailInput.value, passInput.value)
          .catch(e => authError.textContent = e.message);
      };
      signupBtn.onclick = () => {
        authError.textContent = "";
        auth.createUserWithEmailAndPassword(emailInput.value, passInput.value)
          .catch(e => authError.textContent = e.message);
      };

      // On auth state changed
      auth.onAuthStateChanged(async user => {
        if (user) {
          authContainer.classList.add("hidden");
          dashboard.classList.remove("hidden");
          await initApp(user);
        } else {
          dashboard.classList.add("hidden");
        }
      });

      async function initApp(user) {
        const token = await user.getIdToken();

        // Fetch & render bins
        fetch("/api/bins", { headers: { Authorization: "Bearer " + token } })
          .then(r => r.json()).then(data => renderBins(data.bins));

        // Real-time updates
        const socket = io({ auth: { token } });
        socket.on("bins_update", ({ bins }) => renderBins(bins));

        // Donation history chart
        const donRes = await fetch("/api/donations/history", {
          headers: { Authorization: "Bearer " + token }
        });
        const donData = await donRes.json();
        new Chart(donationsCtx, {
          type: "line",
          data: {
            labels: donData.history.map(h => new Date(h.timestamp).toLocaleDateString()),
            datasets: [{
              label: "Donations",
              data: donData.history.map(h => h.donations),
              borderColor: "rgb(53,162,235)",
              fill: false
            }]
          }
        });

        // Bin weight history chart
        const binRes = await fetch("/api/bins/history", {
          headers: { Authorization: "Bearer " + token }
        });
        const binData = await binRes.json();
        new Chart(binsCtx, {
          type: "line",
          data: {
            labels: binData.history.map(h => new Date(h.timestamp).toLocaleTimeString()),
            datasets: [{
              label: "Weight (kg)",
              data: binData.history.map(h => h.weight),
              borderColor: "rgb(75,192,192)",
              fill: false
            }]
          }
        });

        // Placeholder prediction & routes
        predictionEl.textContent = "— waiting for prediction —";
        renderRoutes({ A:0, B:4, C:2, D:5 });

        // Add bin form
        addBinForm.onsubmit = e => {
          e.preventDefault();
          addBinError.textContent = "";
          const f = new FormData(addBinForm);
          fetch("/api/bins", {
            method: "POST",
            headers: {
              "Content-Type":"application/json",
              Authorization:"Bearer "+token
            },
            body: JSON.stringify({
              location: f.get("location"),
              weight: parseFloat(f.get("weight"))
            })
          })
          .then(r=>r.json().then(j=>{ if(!r.ok) throw new Error(j.error); addBinForm.reset(); }))
          .catch(err=>addBinError.textContent=err.message);
        };

        // Load NGOs
        async function loadNGOs() {
          const res = await fetch("/api/ngo_requests", { headers:{Authorization:"Bearer "+token} });
          const data = await res.json();
          renderNGOs(data.ngos);
        }
        await loadNGOs();

        // Add NGO
        addNgoForm.onsubmit = async e => {
          e.preventDefault();
          addNgoError.textContent = "";
          const f = new FormData(addNgoForm);
          const name = f.get("name"), urgency = parseFloat(f.get("urgency"));
          const res = await fetch("/api/ngo_requests", {
            method: "POST",
            headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
            body: JSON.stringify({ name, urgency })
          });
          const j = await res.json();
          if(!res.ok) addNgoError.textContent = j.error||"Unknown error";
          else { addNgoForm.reset(); loadNGOs(); }
        };

        // Match donations
        matchBtn.onclick = async () => {
          matchesList.innerHTML = "";
          const res = await fetch("/api/optimizer/match", { headers:{Authorization:"Bearer "+token} });
          const data = await res.json();
          data.matches.forEach(m=>{
            const li = document.createElement("li");
            li.textContent = `NGO ${m.ngo_id} ← Bin ${m.bin_id}`;
            li.className="px-4 py-2 bg-[#1B2127] text-white rounded-lg";
            matchesList.appendChild(li);
          });
        };
      }

      // Render helpers
      function renderBins(bins) {
        binList.innerHTML = "";
        bins.forEach(b=>{
          const li=document.createElement("li");
          li.textContent=`${b.location||b.id}: ${b.weight||0} kg`;
          li.className="px-4 py-2 bg-[#1B2127] text-white rounded-lg";
          binList.appendChild(li);
        });
      }

      function renderRoutes(routes) {
        routesList.innerHTML = "";
        for(const [dest,cost] of Object.entries(routes)) {
          const li=document.createElement("li");
          li.textContent=`To ${dest}: ${cost}`;
          li.className="px-4 py-2 bg-[#1B2127] text-white rounded-lg";
          routesList.appendChild(li);
        }
      }

      function renderNGOs(ngos) {
        ngoList.innerHTML = "";
        ngos.forEach(n=>{
          const li=document.createElement("li");
          li.textContent=`${n.name} (Urgency: ${n.urgency})`;
          li.className="px-4 py-2 bg-[#1B2127] text-white rounded-lg";
          ngoList.appendChild(li);
        });
      }
    </script>
  </body>
</html>
